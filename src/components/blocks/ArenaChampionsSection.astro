---
import BrutalHeading from '../atoms/BrutalHeading.astro';
import BrutalCard from '../atoms/BrutalCard.astro';
import ChampionsGrid from '../atoms/ChampionsGrid.astro';
import VideosGrid from '../atoms/VideosGrid.astro';
import WallSpecs from './arena/WallSpecs.astro';
import CompetitionHistory from './arena/CompetitionHistory.astro';
import { competitionData } from '../../data/competition-data.js';

const { historyEvents, champions, videos } = competitionData.arena;

// Ajouter BASE_URL aux chemins des photos et vid√©os
const baseUrl = import.meta.env.BASE_URL;

const videosWithBaseUrl = videos.map((video) => ({
  ...video,
  videoUrl: `${baseUrl}${video.videoUrl}`,
  thumbnail: `${baseUrl}${video.thumbnail}`,
}));
---

<section class="brutal-section brutal-section--mint" id="arena">
  <div class="brutal-container">
    <!-- TITRE PRINCIPAL -->
    <div style="margin-bottom: 3rem; text-align: center;">
      <BrutalHeading level={2} rotation={-2} shadow={true} class="brutal-title text-l2">
        üèÜ L'AR√àNE DES CHAMPIONS
      </BrutalHeading>
    </div>

    <!-- 1. DONN√âES TECHNIQUES DU MUR (fond blanc) -->
    <WallSpecs />

    <!-- 2. TEXTE 20 ANS -->
    <div
      class="competition-fact"
      style="
      background: var(--brutal-black);
      color: var(--brutal-white);
      border: 4px solid var(--brutal-white);
      box-shadow: 8px 8px 0 var(--brutal-white);
      padding: 2rem;
      margin: 3rem 0;
      transform: rotate(-1deg);
      font-size: 1.25rem;
      line-height: 1.8;
      text-align: center;
      font-weight: 700;
      width: 100%;
    "
    >
      <p style="margin: 0;">
        Le mur de Saint-Pierre f√™tera ses
        <span
          style="
          background: var(--brutal-ice);
          color: var(--brutal-black);
          padding: 0.1rem 0.4rem;
          display: inline-block;
          font-family: 'Space Mono', monospace;
          font-size: 1rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.02em;
          transform: rotate(-0.5deg);
        "
          >20 ans</span
        > !<br />
        Depuis
        <span
          style="
          background: var(--brutal-ice);
          color: var(--brutal-black);
          padding: 0.1rem 0.4rem;
          display: inline-block;
          font-family: 'Space Mono', monospace;
          font-size: 1rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.02em;
          transform: rotate(0.5deg);
        "
          >2006</span
        >, ce mur de
        <span
          style="
          background: var(--brutal-ice);
          color: var(--brutal-black);
          padding: 0.1rem 0.4rem;
          display: inline-block;
          font-family: 'Space Mono', monospace;
          font-size: 1rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.02em;
          transform: rotate(-0.5deg);
        "
          >14,5 m√®tres</span
        >
        accueille les futures stars de l'escalade.
        <span
          style="
          background: var(--brutal-ice);
          color: var(--brutal-black);
          padding: 0.1rem 0.4rem;
          display: inline-block;
          font-family: 'Space Mono', monospace;
          font-size: 1rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.02em;
          transform: rotate(0.5deg);
        "
          >2026 = 20 ans pile !</span
        >
      </p>
    </div>

    <!-- 3. PALMAR√àS ORGANISATIONNEL (fond blanc) -->
    <CompetitionHistory />

    <!-- 4. CHAMPIONS QUI ONT GRIMP√â ICI (fond noir) -->
    <div style="margin-top: 3rem;">
      <BrutalCard variant="black" rotation={-2}>
        <div style="padding: 2rem;">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div
              style="background: var(--brutal-ice); padding: 0.5rem 1.5rem; display: inline-block;"
            >
              <h3
                style="color: var(--brutal-black); font-size: 1.75rem; margin: 0; font-family: 'Space Grotesk', sans-serif; font-weight: 700; text-transform: uppercase;"
              >
                Quelques champions qui ont grimp√© ici
              </h3>
            </div>
          </div>

          <ChampionsGrid champions={champions} />
        </div>
      </BrutalCard>
    </div>

    <!-- 5. VID√âOS (fond blanc) -->
    <div style="margin-top: 3rem;">
      <BrutalCard variant="default" rotation={2}>
        <div style="padding: 2rem;">
          <div style="text-align: center; margin-bottom: 2rem;">
            <div
              style="background: var(--brutal-ice); padding: 0.5rem 1.5rem; display: inline-block;"
            >
              <h3
                style="color: var(--brutal-black); font-size: 1.75rem; margin: 0; font-family: 'Space Grotesk', sans-serif; font-weight: 700; text-transform: uppercase;"
              >
                Un aper√ßu de l'ambiance qui vous attend
              </h3>
            </div>
          </div>

          <h4 style="text-align: center; color: var(--brutal-black); margin-bottom: 2rem;">
            Vid√©os de nos comp√©titions
          </h4>

          <VideosGrid videos={videosWithBaseUrl} />
        </div>
      </BrutalCard>
    </div>

    <!-- 6. PHRASE FINALE -->
    <div style="margin: 4rem 0 2rem; text-align: center;">
      <div
        style="display: inline-block; background: var(--brutal-black); padding: 1.5rem 2rem; transform: rotate(-1deg); border: 4px solid var(--brutal-white); box-shadow: 8px 8px 0 var(--brutal-white);"
      >
        <h3
          style="color: var(--brutal-white); font-size: var(--size-l4); margin: 0; font-weight: 800; text-transform: uppercase; line-height: 1.2;"
        >
          16-17 mai 2026 : <span style="color: var(--brutal-ice);"
            >Qui marquera cette √©dition anniversaire ?</span
          >
        </h3>
      </div>
    </div>
  </div>

  <!-- Modal Gallery -->
  <div id="photo-modal" class="brutal-modal">
    <div class="brutal-modal-content">
      <img id="modal-image" class="brutal-modal-image" src="" alt="" />

      <!-- Bouton fermeture -->
      <button id="close-modal" class="brutal-modal-close"> ‚úï </button>

      <!-- Navigation -->
      <button id="prev-photo" class="brutal-modal-nav brutal-modal-nav--prev"> ‚Üê </button>

      <button id="next-photo" class="brutal-modal-nav brutal-modal-nav--next"> ‚Üí </button>

      <!-- Compteur -->
      <div id="photo-counter" class="brutal-modal-counter">1 / 3</div>
    </div>
  </div>

  <!-- Modal Vid√©os -->
  <div id="video-modal" class="brutal-modal">
    <div class="brutal-modal-content">
      <div id="video-content" class="video-modal-content">
        <!-- Le contenu vid√©o sera ins√©r√© ici -->
      </div>

      <!-- Bouton fermeture -->
      <button id="close-video-modal" class="brutal-modal-close"> ‚úï </button>

      <!-- Navigation -->
      <button id="prev-video" class="brutal-modal-nav brutal-modal-nav--prev"> ‚Üê </button>

      <button id="next-video" class="brutal-modal-nav brutal-modal-nav--next"> ‚Üí </button>

      <!-- Compteur et titre -->
      <div id="video-counter" class="brutal-modal-counter">
        <div class="video-counter-text">1 / 5</div>
        <div class="video-title-modal"></div>
      </div>
    </div>
  </div>
</section>

<style>
  .brutal-section {
    background: var(--brutal-ice);
    padding: 4rem 2rem;
    position: relative;
  }

  /* Modal Gallery (copi√© de VenueSection) */
  .brutal-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    align-items: center;
    justify-content: center;
  }

  .brutal-modal-content {
    position: relative;
    max-width: 90%;
    max-height: 90%;
  }

  .brutal-modal-image {
    width: 100%;
    height: auto;
    max-height: 85vh;
    object-fit: contain;
    border: 4px solid var(--brutal-white);
    box-shadow: 0 0 50px rgba(127, 229, 176, 0.3);
  }

  .brutal-modal-close {
    position: absolute;
    top: -50px;
    right: 0;
    background: var(--brutal-ice);
    color: var(--brutal-black);
    font-size: 2rem;
    font-weight: 900;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .brutal-modal-close:hover {
    background: var(--brutal-white);
    transform: scale(1.1);
  }

  .brutal-modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: var(--brutal-ice);
    color: var(--brutal-black);
    font-size: 2rem;
    font-weight: 900;
    border: none;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .brutal-modal-nav--prev {
    left: 20px;
  }

  .brutal-modal-nav--next {
    right: 20px;
  }

  .brutal-modal-nav:hover {
    background: var(--brutal-white);
    transform: translateY(-50%) scale(1.1);
  }

  .brutal-modal-counter {
    position: absolute;
    bottom: -50px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--brutal-black);
    color: var(--brutal-white);
    padding: 0.75rem 1.5rem;
    font-weight: 700;
    font-size: 1rem;
    border: 2px solid var(--brutal-white);
  }

  /* Modal vid√©o sp√©cifique */
  .video-modal-content {
    width: 100%;
    max-width: 800px;
    aspect-ratio: 16/9;
    background: var(--brutal-black);
    border: 4px solid var(--brutal-white);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--brutal-white);
    font-size: 1.5rem;
  }

  .video-counter-text {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }

  .video-title-modal {
    font-size: 0.875rem;
    text-align: center;
    opacity: 0.8;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .brutal-section {
      padding: 3rem 1rem;
    }

    .brutal-modal-nav {
      font-size: 1.5rem;
      padding: 0.75rem;
    }

    .brutal-modal-nav--prev {
      left: 10px;
    }

    .brutal-modal-nav--next {
      right: 10px;
    }

    .brutal-modal-close {
      font-size: 1.5rem;
      padding: 0.25rem 0.5rem;
      top: -40px;
    }

    .brutal-modal-counter {
      bottom: -40px;
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
    }
  }
</style>

<script>
  import { BrutalModal } from '../../scripts/modal-utils';

  document.addEventListener('DOMContentLoaded', function () {
    // --- GESTION GALERIE PHOTOS ---
    const galleryItems = document.querySelectorAll('.brutal-gallery-item');

    if (galleryItems.length > 0) {
      const images = Array.from(galleryItems).map((item) => {
        const img = item.querySelector('img');
        return {
          src: img?.src || '',
          alt: img?.alt || '',
        };
      });

      let currentImageIndex = 0;
      const modalImage = document.getElementById('modal-image') as HTMLImageElement | null;
      const counter = document.getElementById('photo-counter');

      try {
        const photoModal = new BrutalModal('photo-modal');

        function updatePhotoModal() {
          if (!modalImage || !counter) return;
          modalImage.src = images[currentImageIndex].src;
          modalImage.alt = images[currentImageIndex].alt;
          counter.textContent = `${currentImageIndex + 1} / ${images.length}`;
        }

        // Triggers ouverture
        galleryItems.forEach((item, index) => {
          item.addEventListener('click', () => {
            currentImageIndex = index;
            updatePhotoModal();
            photoModal.open();
          });
        });

        // Navigation
        document.getElementById('prev-photo')?.addEventListener('click', (e) => {
          e.stopPropagation();
          currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
          updatePhotoModal();
        });

        document.getElementById('next-photo')?.addEventListener('click', (e) => {
          e.stopPropagation();
          currentImageIndex = (currentImageIndex + 1) % images.length;
          updatePhotoModal();
        });

        // Clavier sp√©cifique galerie
        document.addEventListener('keydown', (e) => {
          if (photoModal.isOpen) {
            switch (e.key) {
              case 'ArrowLeft':
                currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                updatePhotoModal();
                break;
              case 'ArrowRight':
                currentImageIndex = (currentImageIndex + 1) % images.length;
                updatePhotoModal();
                break;
            }
          }
        });
      } catch (e) {
        console.warn('Photo modal init failed:', e);
      }
    }

    // --- GESTION VID√âOS ---
    const videoTiles = document.querySelectorAll('.video-tile');
    if (videoTiles.length > 0) {
      const videosData = Array.from(videoTiles).map((tile) => {
        const title = tile.querySelector('.video-title')?.textContent || '';
        const videoUrl = (tile as HTMLElement).dataset.videoUrl || '';
        return { title, url: videoUrl };
      });

      let currentVideoIndex = 0;
      const videoContent = document.getElementById('video-content');
      const videoCounter = document.querySelector('#video-counter .video-counter-text');
      const videoTitleModal = document.querySelector('#video-counter .video-title-modal');

      try {
        const videoModal = new BrutalModal('video-modal', {
          onClose: () => {
            // Arr√™ter la vid√©o en vidant le contenu
            if (videoContent) videoContent.innerHTML = '';
          },
        });

        function updateVideoModal() {
          if (!videoContent || !videoCounter || !videoTitleModal) return;

          const video = videosData[currentVideoIndex];

          // Mise √† jour du compteur et titre
          videoCounter.textContent = `${currentVideoIndex + 1} / ${videosData.length}`;
          videoTitleModal.textContent = video.title;

          // Injection du player
          if (video.url) {
            videoContent.innerHTML = `
              <video controls autoplay class="modal-video-player" style="width: 100%; height: 100%; object-fit: contain;">
                <source src="${video.url}" type="video/mp4">
                Votre navigateur ne supporte pas la lecture de vid√©os.
              </video>
            `;
          }
        }

        // Triggers ouverture
        videoTiles.forEach((tile, index) => {
          tile.addEventListener('click', () => {
            currentVideoIndex = index;
            updateVideoModal();
            videoModal.open();
          });
        });

        // Navigation
        document.getElementById('prev-video')?.addEventListener('click', (e) => {
          e.stopPropagation();
          currentVideoIndex = (currentVideoIndex - 1 + videosData.length) % videosData.length;
          updateVideoModal();
        });

        document.getElementById('next-video')?.addEventListener('click', (e) => {
          e.stopPropagation();
          currentVideoIndex = (currentVideoIndex + 1) % videosData.length;
          updateVideoModal();
        });

        // Clavier sp√©cifique vid√©o
        document.addEventListener('keydown', (e) => {
          if (videoModal.isOpen) {
            switch (e.key) {
              case 'ArrowLeft':
                currentVideoIndex = (currentVideoIndex - 1 + videosData.length) % videosData.length;
                updateVideoModal();
                break;
              case 'ArrowRight':
                currentVideoIndex = (currentVideoIndex + 1) % videosData.length;
                updateVideoModal();
                break;
            }
          }
        });
      } catch (e) {
        console.warn('Video modal init failed:', e);
      }
    }
  });
</script>
