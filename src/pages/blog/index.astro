---
import { getCollection } from 'astro:content';
import BaseLayout from '../../components/layout/BaseLayout.astro';
import BlogCard from '../../components/atoms/BlogCard.astro';
import BrutalHeading from '../../components/atoms/BrutalHeading.astro';
import BlogFooterSection from '../../components/blocks/BlogFooterSection.astro';
import AnnonceurModal from '../../components/blocks/AnnonceurModal.astro';

// Get all blog posts sorted by date (newest first)
const allPosts = (await getCollection('blog')).sort(
  (a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime()
);

// Pagination
const POSTS_PER_PAGE = 10;
const totalPages = Math.ceil(allPosts.length / POSTS_PER_PAGE);

// For static generation, create all possible pages
export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const totalPages = Math.ceil(allPosts.length / 10);

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: (i + 1).toString() },
  }));
}

// Get current page
const currentPage = parseInt(Astro.params.page || '1');
const pageIndex = currentPage - 1;

// Calculate pagination
const startIndex = pageIndex * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const paginatedPosts = allPosts.slice(startIndex, endIndex);

const hasPreviousPage = currentPage > 1;
const hasNextPage = pageIndex < totalPages - 1;
const previousPageUrl = currentPage === 2 ? '/blog' : `/blog/${currentPage - 1}`;
const nextPageUrl = `/blog/${currentPage + 1}`;
---

<BaseLayout title="Blog - Championnats de France Jeunes 2026" description="Actualit√©s et articles des Championnats de France Jeunes Escalade 2026">
  <section class="brutal-section brutal-section--white blog-section">
    <div class="brutal-container">
      <!-- Header -->
      <div class="blog-header">
        <BrutalHeading level={1} rotation={-2} shadow={true} class="blog-page-title text-l2">
          üì∞ BLOG
        </BrutalHeading>
        <p class="blog-subtitle">Actualit√©s et articles des Championnats de France Jeunes Escalade 2026</p>
        <div class="blog-rss-link">
          <a href="/rss.xml" class="rss-button">üì° S'abonner au flux RSS</a>
        </div>
      </div>

      <!-- Articles Grid -->
      <div class="blog-grid">
        {paginatedPosts.map((post) => (
          <BlogCard
            title={post.data.title}
            description={post.data.description}
            publishDate={post.data.publishDate}
            tags={post.data.tags}
            slug={post.slug}
          />
        ))}
      </div>

      {paginatedPosts.length === 0 && (
        <div class="blog-empty">
          <p>Aucun article pour le moment. Revenez bient√¥t !</p>
        </div>
      )}

      <!-- Pagination -->
      {totalPages > 1 && (
        <div class="blog-pagination">
          {hasPreviousPage && (
            <a href={previousPageUrl} class="brutal-btn brutal-btn-pagination">
              ‚Üê Pr√©c√©dent
            </a>
          )}

          <div class="pagination-info">
            Page <strong>{currentPage}</strong> sur <strong>{totalPages}</strong>
          </div>

          {hasNextPage && (
            <a href={nextPageUrl} class="brutal-btn brutal-btn-pagination">
              Suivant ‚Üí
            </a>
          )}
        </div>
      )}
    </div>
  </section>
  <BlogFooterSection />
  <AnnonceurModal />
</BaseLayout>

<style>
  .blog-section {
    padding: var(--space-large) 0;
  }

  .blog-header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .blog-page-title {
    margin-bottom: 1rem;
  }

  .blog-subtitle {
    font-size: 1.2rem;
    color: var(--brutal-gray);
    max-width: 600px;
    margin: 0 auto 1.5rem;
  }

  .blog-rss-link {
    margin-top: 1.5rem;
  }

  .rss-button {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: var(--brutal-white);
    color: var(--brutal-black);
    border: 3px solid var(--brutal-black);
    text-decoration: none;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.95rem;
    letter-spacing: 0.05em;
    box-shadow: 6px 6px 0 var(--brutal-black);
    transform: rotate(-1deg);
    transition:
      transform 0.2s ease,
      box-shadow 0.2s ease;
  }

  .rss-button:hover {
    transform: translate(-2px, -2px) rotate(0deg);
    box-shadow: 8px 8px 0 var(--brutal-black);
  }

  .blog-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 4rem;
  }

  .blog-empty {
    text-align: center;
    padding: 3rem;
    background: var(--brutal-ice);
    border: 4px solid var(--brutal-black);
    box-shadow: 8px 8px 0 var(--brutal-black);
  }

  .blog-empty p {
    font-size: 1.25rem;
    color: var(--brutal-black);
    font-weight: 700;
  }

  .blog-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    background: var(--brutal-ice);
    border: 4px solid var(--brutal-black);
    box-shadow: 8px 8px 0 var(--brutal-black);
    flex-wrap: wrap;
  }

  .brutal-btn-pagination {
    min-width: 150px;
  }

  .pagination-info {
    font-size: 1rem;
    font-weight: 700;
    text-transform: uppercase;
    color: var(--brutal-black);
    white-space: nowrap;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .blog-grid {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .blog-pagination {
      flex-direction: column;
      gap: 1rem;
    }

    .brutal-btn-pagination {
      width: 100%;
    }
  }
</style>
