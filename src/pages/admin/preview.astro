---
import BlogPostLayout from '../../components/layout/BlogPostLayout.astro';

// Dummy initial data
const props = {
  title: "Titre de l'article",
  description: 'Description...',
  publishDate: new Date(),
  tags: ['tag1', 'tag2'],
  flickrAlbumUrl: undefined,
};

// Security check
if (import.meta.env.PROD) {
  return Astro.redirect('/');
}
---

<style is:global>
  @media print {
    .blog-back-link,
    .blog-post-nav,
    .blog-post-breadcrumb {
      display: none !important;
    }

    /* Ensure background graphics (like the bandeau) are printed */
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
  }
</style>

<BlogPostLayout {...props}>
  <div id="preview-content">Chargement de l'aperçu...</div>
</BlogPostLayout>

<script type="module" is:inline>
  import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js';

  const titleEl = document.querySelector('.blog-bandeau-title');
  const dateEl = document.querySelector('.blog-post-date .value');
  const contentEl = document.getElementById('preview-content');
  const tagsContainer = document.querySelector('.blog-post-tags');

  // Flickr elements might be harder to update if they are components.
  // We might need to manually handle the iframe injection if the component is static.
  // Let's see if we can target the gallery container.

  function getFlickrIds(url) {
    if (!url) return null;
    const match = url.match(/\/photos\/([^/]+)\/albums\/(\d+)/);
    if (match) return { userId: match[1], albumId: match[2] };
    return null;
  }

  function updateFlickr(url, title) {
    // If no wrapper exists (initial render didn't have one), we might need to create it
    // or just warn. Ideally the layout should have an empty container we can target.
    // But BlogPostLayout conditionally renders it.

    // Strategy: look for .blog-post-content and insert/update after it if needed.
    // For now, let's try to find an existing wrapper or create one.

    let wrapper = document.querySelector('.blog-post-gallery-wrapper');
    const contentArticle = document.querySelector('.blog-post-content');

    const ids = getFlickrIds(url);

    if (!ids) {
      if (wrapper) wrapper.style.display = 'none';
      return;
    }

    if (!wrapper && contentArticle) {
      wrapper = document.createElement('div');
      wrapper.className = 'blog-post-gallery-wrapper';
      // Insert before nav
      const nav = document.querySelector('.blog-post-nav');
      contentArticle.parentNode.insertBefore(wrapper, nav);
    }

    if (wrapper) {
      wrapper.style.display = 'block';
      wrapper.innerHTML = `
            <figure class="flickr-gallery" style="margin: 3rem 0; border: 4px solid var(--brutal-black); box-shadow: 12px 12px 0 var(--brutal-black); padding: 2rem; background: var(--brutal-white); transform: rotate(-1deg);">
              <p class="album-intro" style="margin: 0 0 1.5rem 0; padding: 1rem 1.25rem; font-size: 0.95rem; line-height: 1.6; color: var(--brutal-ice); font-weight: 500; border: 3px solid var(--brutal-ice); background: var(--brutal-black); box-shadow: 6px 6px 0 var(--brutal-ice);">
                Revivez l'ambiance de la compétition à travers l'album :
                <br />
                <strong>${title || 'Album'}</strong>
              </p>
              <div class="flickr-gallery-container" style="position: relative; width: 100%; margin-bottom: 1.5rem; overflow: hidden; border: 2px solid var(--brutal-black);">
                <iframe
                  title="${title}"
                  src="https://www.flickr.com/photos/${ids.userId}/albums/${ids.albumId}/player/"
                  width="100%"
                  height="500"
                  style="border: none; display: block;"
                  allowfullscreen
                ></iframe>
              </div>
            </figure>
          `;
    }
  }

  window.addEventListener('message', async (event) => {
    const data = event.data;
    if (!data || data.type !== 'preview-update') return;

    const { frontmatter, content } = data;

    // Update Title
    if (titleEl) titleEl.textContent = frontmatter.title || 'Sans titre';

    // Update Date
    if (dateEl && frontmatter.publishDate) {
      try {
        const date = new Date(frontmatter.publishDate);
        dateEl.textContent = new Intl.DateTimeFormat('fr-FR', {
          day: '2-digit',
          month: 'long',
          year: 'numeric',
        }).format(date);
      } catch (e) {
        // ignore date error
      }
    }

    // Update Tags
    if (tagsContainer && frontmatter.tags) {
      tagsContainer.innerHTML = '';
      frontmatter.tags.forEach((tag) => {
        const span = document.createElement('span');
        span.className = 'blog-post-tag';
        span.textContent = tag;
        tagsContainer.appendChild(span);
      });
    }

    // Update Content
    if (contentEl) {
      contentEl.innerHTML = marked.parse(content);
    }

    // Update Flickr
    updateFlickr(frontmatter.flickrAlbumUrl, frontmatter.albumTitle || frontmatter.title);
  });

  // Signal ready
  window.parent.postMessage({ type: 'preview-ready' }, '*');
</script>
